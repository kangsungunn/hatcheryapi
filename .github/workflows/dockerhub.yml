name: Build & Push API Image to DockerHub

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    IMAGE_NAME: kangsungunn/api-hatchery-kr
    CONTAINER_NAME: api-hatchery-kr
    CONTAINER_PORT: 8080
    # 추가 옵션 (필요시 주석 해제)
    # HOST_PORT: 8080  # 호스트 포트 (기본값: CONTAINER_PORT와 동일)
    # MEMORY_LIMIT: "1g"
    # CPU_LIMIT: "1.5"

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to DockerHub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  build-args: |
                      BUILD_TIME=${{ github.event.head_commit.timestamp || github.run_started_at }}
                      BUILD_VERSION=${{ github.sha }}
                      GIT_COMMIT=${{ github.sha }}
                      GIT_BRANCH=${{ github.ref_name }}
                  tags: |
                      ${{ env.IMAGE_NAME }}:latest
                      ${{ env.IMAGE_NAME }}:${{ github.sha }}

    deploy:
        runs-on: ubuntu-latest
        needs: build-and-push
        if: github.ref == 'refs/heads/main'

        steps:
            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

            - name: Deploy to EC2
              run: |
                  ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e
                    
                    echo "=== Starting Deployment ==="
                    
                    # 디스크 공간 확인
                    echo "Checking disk space..."
                    df -h /
                    
                    # Docker 정리 (디스크 공간 확보)
                    echo "Cleaning up Docker resources..."
                    # 중지된 컨테이너 삭제
                    docker container prune -f || true
                    # 사용하지 않는 이미지 삭제 (현재 실행 중인 컨테이너의 이미지는 제외)
                    docker image prune -a -f --filter "until=24h" || true
                    # 사용하지 않는 볼륨 삭제
                    docker volume prune -f || true
                    # Docker 시스템 정리
                    docker system prune -f || true
                    
                    # 정리 후 디스크 공간 확인
                    echo "Disk space after cleanup:"
                    df -h /
                    
                    # 최신 이미지 pull
                    echo "Pulling latest image from Docker Hub..."
                    docker pull ${{ env.IMAGE_NAME }}:latest
                    
                    # 기존 컨테이너 중지 및 제거
                    echo "Stopping existing container..."
                    docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
                    docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
                    
                    # 새 컨테이너 실행
                    echo "Starting new container..."
                    docker run -d \
                      --name ${{ env.CONTAINER_NAME }} \
                      -p ${{ env.CONTAINER_PORT }}:${{ env.CONTAINER_PORT }} \
                      --env-file ~/.env \
                      --restart unless-stopped \
                      --memory="1g" \
                      --cpus="1.5" \
                      ${{ env.IMAGE_NAME }}:latest
                    
                    # 참고: 추가 옵션이 필요한 경우 아래 주석을 해제하고 수정하세요
                    # -v /host/path:/container/path \  # 볼륨 마운트
                    # --network custom-network \        # 커스텀 네트워크
                    # -e KEY=value \                    # 개별 환경변수
                    
                    # 실행 확인
                    echo "Waiting for container to start..."
                    sleep 5
                    
                    # 상태 확인
                    if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
                      echo "✅ Deployment successful!"
                      docker ps | grep ${{ env.CONTAINER_NAME }}
                    else
                      echo "❌ Deployment failed!"
                      docker logs ${{ env.CONTAINER_NAME }}
                      exit 1
                    fi
                  EOF
